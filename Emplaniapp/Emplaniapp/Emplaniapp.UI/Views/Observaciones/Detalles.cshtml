
@model Emplaniapp.Abstracciones.ModelosParaUI.EmpleadoDto
@using Microsoft.AspNet.Identity
@using System.Security.Claims

@{
    ViewBag.Title = $"{Model.nombre} {Model.primerApellido} {Model.segundoApellido}";
    var seccionActiva = ViewBag.Seccion ?? "Observaciones";
}

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>


<!-- Título del empleado -->
<div class="row">
    <div class="col-md-12">
        <a class="btn btn-light text-primary mb-2" href="@Url.Action( "listarHojaResumen", "HojaResumen")">
            <i class="bi bi-arrow-left-short"></i>
            Volver
        </a>
        <br />
        <h2 class="titulo">@Model.nombre @Model.primerApellido @Model.segundoApellido</h2>
        <br />
    </div>
</div>




<!-- Enlaces de navegación -->
<div class="row">
    <div class="col-md-12">
        <div class="nav nav-tabs" role="tablist">
            <a href="@Url.Action("DetallesRemu", "Remuneraciones", new { id = Model.idEmpleado })" class="@(seccionActiva == "Remuneraciones" ? "active" : "")  nav-item nav-link">Remuneraciones</a>
            <a href="@Url.Action("Detalles", "Retenciones", new { id = Model.idEmpleado })" class="@(seccionActiva == "Retenciones" ? "active" : "")  nav-item nav-link">Retenciones</a>
            <a href="@Url.Action("Detalles", "Liquidaciones", new { id = Model.idEmpleado })" class="@(seccionActiva == "Liquidacion" ? "active" : "")  nav-item nav-link">Liquidación</a>
            <a href="@Url.Action("Detalles", "Observaciones", new { id = Model.idEmpleado, seccion = "Observaciones" })" class="@(seccionActiva == "Observaciones" ? "active" : "")  nav-item nav-link">Observaciones</a>
        </div>
        <br />
    </div>
</div>



<!-- Contenido -->
<div class="row">
    <div class="col-md-12">
        @if (seccionActiva == "Observaciones")
        {
            <div id="contenedor-lista-observaciones"> </div>
        }
    </div>
</div>





@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Html.Partial("_AdminPasswordModal")

    <script>
        $(document).ready(function () {

            // --- INICIO: Lógica de carga y filtrado de observaciones ---
            function cargarObservaciones() {
                var empleadoId = @Model.idEmpleado;
                var container = $('#contenedor-lista-observaciones');

                // Leer valores de los filtros
                var ano = container.find('#filtro-ano').val();
                var mes = container.find('#filtro-mes').val();
                var usuarioId = container.find('#filtro-usuario').val();

                var url = '@Url.Action("ObtenerListaObservaciones", "Observaciones")' +
                          '?id=' + empleadoId +
                          '&ano=' + (ano || '') +
                          '&mes=' + (mes || '') +
                          '&usuarioId=' + (usuarioId || '');

                container.html("<p>Cargando observaciones...</p>");

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function (response) {
                        if (response.success) {
                            container.html(response.html);
                        } else {
                            container.html("<p class='text-danger'>Hubo un problema al obtener las observaciones.</p>");
                        }
                    },
                    error: function (xhr) {
                        container.html("<p class='text-danger'>Error al cargar las observaciones: " + xhr.status + ' ' + xhr.statusText + "</p>");
                    }
                });
            }

            if ('@seccionActiva' === 'Observaciones') {
                cargarObservaciones();
            }

            

            // Listener para el botón de aplicar filtros
            $('#contenedor-lista-observaciones').on('click', '#btn-aplicar-filtros', function() {
                cargarObservaciones();
            });

            // Listener para el botón de quitar filtros
            $('#contenedor-lista-observaciones').on('click', '#btn-quitar-filtros', function() {
                var container = $('#contenedor-lista-observaciones');
                container.find('#filtro-ano').val('');
                container.find('#filtro-mes').val('');
                container.find('#filtro-usuario').val('');
                cargarObservaciones();
            });

            // --- INICIO: Lógica del modal para agregar/editar observaciones ---
            var modalContainer = $('#modal-container');
            var modalContent = $('#modal-content-container');

            // Abrir modal (agregar/editar)
            $('#contenedor-lista-observaciones').on('click', '.btn-agregar-observacion, .btn-editar-observacion', function () {
                var url = $(this).data('url');
                modalContent.load(url, function () {
                    modalContainer.modal('show');

                    // ✨ CORRECCIÓN: Verificar que jQuery Unobtrusive esté disponible
                    if (typeof $.validator !== 'undefined' && typeof $.validator.unobtrusive !== 'undefined') {
                        $.validator.unobtrusive.parse(modalContent.find('form'));
                    } else {
                        console.warn('jQuery Unobtrusive no está disponible para validación');
                    }
                });
            });

            // Guardar en modal
            modalContainer.on('click', '#btn-guardar-observacion', function () {
                var form = modalContent.find('#observacionForm');

                // ✨ CORRECCIÓN: Validación manual si jQuery Unobtrusive no está disponible
                var isValid = true;
                if (typeof form.valid === 'function') {
                    isValid = form.valid();
                } else {
                    // Validación manual básica
                    var titulo = form.find('input[name="Titulo"]').val().trim();
                    var descripcion = form.find('textarea[name="Descripcion"]').val().trim();

                    if (!titulo || !descripcion) {
                        isValid = false;
                        alert('Por favor, complete todos los campos obligatorios.');
                    }
                }

                if (!isValid) return;

                // ✨ MEJORA: Deshabilitar botón para evitar doble envío
                var btnGuardar = $(this);
                btnGuardar.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Guardando...');

                $.ajax({
                    url: form.attr('action'),
                    method: 'POST',
                    data: form.serialize(),
                    success: function (response) {
                        // ✨ CORRECCIÓN: Manejar respuesta como texto o JSON
                        var responseData = response;
                        if (typeof response === 'string') {
                            try {
                                responseData = JSON.parse(response);
                            } catch (e) {
                                // Si no es JSON, probablemente es HTML de error
                                modalContent.html(response);
                                if (typeof $.validator !== 'undefined' && typeof $.validator.unobtrusive !== 'undefined') {
                                    $.validator.unobtrusive.parse(modalContent.find('form'));
                                }
                                return;
                            }
                        }

                        if (responseData.success) {
                            modalContainer.modal('hide');

                            // ✨ MEJORA: Mostrar mensaje de éxito elegante
                            if (typeof window.showSuccessModal === 'function') {
                                var mensaje = form.find('input[name="IdObservacion"]').val() > 0
                                    ? 'La observación ha sido actualizada exitosamente'
                                    : 'La observación ha sido creada exitosamente';
                                window.showSuccessModal(mensaje);
                            }

                            cargarObservaciones();
                        } else {
                            modalContent.html(responseData);
                            if (typeof $.validator !== 'undefined' && typeof $.validator.unobtrusive !== 'undefined') {
                                $.validator.unobtrusive.parse(modalContent.find('form'));
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error al guardar observación:', error);
                        console.error('Respuesta del servidor:', xhr.responseText);

                        // ✨ MEJORA: Mostrar mensaje de error elegante
                        if (typeof window.showErrorModal === 'function') {
                            window.showErrorModal('Ocurrió un error al guardar la observación. Por favor, intente nuevamente.');
                        } else {
                            alert('Ocurrió un error de comunicación con el servidor.');
                        }
                    },
                    complete: function () {
                        // ✨ MEJORA: Rehabilitar botón
                        btnGuardar.prop('disabled', false).html('Guardar');
                    }
                });
            });


            modalContainer.on('click', '#btn-cancelar-observacion', function () {
                $('#modal-container').modal('hide');
            });

            // ✨ NUEVO: Eliminar observación
            $('#contenedor-lista-observaciones').on('click', '.btn-eliminar-observacion', function () {
                var observacionId = $(this).data('id');
                var observacionTitulo = $(this).data('titulo');

                if (confirm('¿Está seguro de que desea eliminar la observación "' + observacionTitulo + '"? Esta acción no se puede deshacer.')) {
                    $.ajax({
                        url: '@Url.Action("EliminarObservacion", "DatosPersonales")',
                        method: 'POST',
                        data: {
                            id: observacionId,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (response) {
                            if (response.success) {
                                // ✨ MEJORA: Mostrar mensaje de éxito elegante
                                if (typeof window.showSuccessModal === 'function') {
                                    window.showSuccessModal('La observación ha sido eliminada exitosamente');
                                }
                                cargarObservaciones();
                            } else {
                                // ✨ MEJORA: Mostrar mensaje de error elegante
                                if (typeof window.showErrorModal === 'function') {
                                    window.showErrorModal(response.message || 'Ocurrió un error al eliminar la observación');
                                } else {
                                    alert(response.message || 'Ocurrió un error al eliminar la observación');
                                }
                            }
                        },
                        error: function () {
                            // ✨ MEJORA: Mostrar mensaje de error elegante
                            if (typeof window.showErrorModal === 'function') {
                                window.showErrorModal('Ocurrió un error de comunicación con el servidor');
                            } else {
                                alert('Ocurrió un error de comunicación con el servidor');
                            }
                        }
                    });
                }
            });

            // --- FIN: Lógica del modal ---
        });
    </script>
}

<!-- Modal Genérico (Solo el contenedor) -->
<div class="modal fade" id="modal-container" tabindex="-1" role="dialog" aria-labelledby="modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" id="modal-content-container">
            <!-- El contenido completo del modal (header, body, footer) se cargará aquí -->
        </div>
    </div>
</div>
