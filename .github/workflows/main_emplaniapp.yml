name: Deploy ASP.NET MVC (.NET Framework) to Azure

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # Ubicar .sln y proyecto Web
    - name: Locate solution and web project
      shell: pwsh
      run: |
        $sln = Get-ChildItem -Recurse -Filter *.sln | Select-Object -First 1
        if (-not $sln) { throw "No se encontr칩 .sln" }
        "SOLUTION_PATH=$($sln.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append

        $web = Get-ChildItem -Recurse -Filter *.csproj | Where-Object {
          (Select-String -Path $_.FullName -Pattern "Microsoft.WebApplication.targets" -Quiet)
        } | Select-Object -First 1
        if (-not $web) { throw "No se encontr칩 proyecto web" }
        "WEBPROJ_PATH=$($web.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Restore NuGet packages
      run: nuget restore "$env:SOLUTION_PATH"

    - name: Build solution
      run: msbuild "$env:SOLUTION_PATH" /p:Configuration=Release

    # PUBLICAR A CARPETA (transforma Web.Release.config)
    - name: Publish to folder (FileSystem)
      shell: pwsh
      run: |
        $publish = Join-Path $env:GITHUB_WORKSPACE "publish"
        if (Test-Path $publish) { Remove-Item $publish -Recurse -Force }
        New-Item -ItemType Directory -Path $publish | Out-Null

        & msbuild "$env:WEBPROJ_PATH" `
          /p:Configuration=Release `
          /p:DeployOnBuild=true `
          /p:WebPublishMethod=FileSystem `
          /p:DeleteExistingFiles=True `
          /p:PublishUrl="$publish" `
          /verbosity:minimal

        if (-not (Test-Path "$publish/Web.config")) {
          Write-Host "No se gener칩 Web.config"
          Get-ChildItem -Recurse $publish
          throw "Error: No Web.config"
        }

    # Crear ZIP v치lido para ZIPDEPLOY
    - name: Create site ZIP
      shell: pwsh
      run: |
        $publish = Join-Path $env:GITHUB_WORKSPACE "publish"
        $zipPath = Join-Path $env:GITHUB_WORKSPACE "site.zip"

        if (Test-Path $zipPath) { Remove-Item $zipPath -Force }

        Compress-Archive -Path "$publish/*" -DestinationPath $zipPath -Force

        "PACKAGE_PATH=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Append
        Write-Host "ZIP creado: $zipPath"

    # DEPLOY A AZURE WEB APP (ZIPDEPLOY)
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: Emplaniapp
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}
        package: ${{ env.PACKAGE_PATH }}
