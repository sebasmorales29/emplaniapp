name: Deploy ASP.NET MVC (.NET Framework) to Azure

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: windows-latest

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Restore NuGet packages
      run: nuget restore "**/*.sln"

    - name: Build solution (Release)
      run: msbuild "**/*.sln" /p:Configuration=Release

    # USAR PackageTmp COMO SITIO PUBLICADO
    - name: Locate PackageTmp output
      id: findpkg
      shell: pwsh
      run: |
        $pkg = Get-ChildItem -Recurse -Directory -Filter PackageTmp |
               Where-Object { $_.FullName -match 'obj\\Release\\Package\\PackageTmp$' } |
               Select-Object -First 1

        if (-not $pkg) { throw "NO SE ENCONTRÃ“ PackageTmp. Revisar proyecto." }

        Write-Host "Encontrado PackageTmp: $($pkg.FullName)"
        "PKGTMP=$($pkg.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append

    # ZIPDEPLOY ZIP
    - name: Create deployable ZIP
      shell: pwsh
      run: |
        $zipPath = Join-Path $env:GITHUB_WORKSPACE "site.zip"
        if (Test-Path $zipPath) { Remove-Item $zipPath -Force }

        Compress-Archive -Path "$env:PKGTMP/*" -DestinationPath $zipPath -Force
        "PACKAGE_PATH=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Append
        Write-Host "ZIP creado en: $zipPath"

    # DEPLOY A AZURE
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: Emplaniapp
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}
        package: ${{ env.PACKAGE_PATH }}
