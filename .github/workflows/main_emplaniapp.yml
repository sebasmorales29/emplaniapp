name: Deploy ASP.NET MVC (.NET Framework) to Azure

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: windows-latest

    steps:

    # 1Ô∏è‚É£ C√≥digo fuente
    - name: Checkout
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Configurar herramientas
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # 3Ô∏è‚É£ Detectar soluci√≥n y proyecto web
    - name: Locate solution and web project
      shell: pwsh
      run: |
        $sln = Get-ChildItem -Recurse -Filter *.sln | Select-Object -First 1
        if (-not $sln) { throw "‚ùå No se encontr√≥ ning√∫n archivo .sln en el repositorio." }
        "SOLUTION_PATH=$($sln.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append

        $web = Get-ChildItem -Recurse -Filter *.csproj | Where-Object {
          (Select-String -Path $_.FullName -Pattern "Microsoft.WebApplication.targets" -Quiet)
        } | Select-Object -First 1
        if (-not $web) { throw "‚ùå No se encontr√≥ ning√∫n proyecto web (.csproj)." }
        "WEBPROJ_PATH=$($web.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append

        Write-Host "‚úÖ SLN: $env:SOLUTION_PATH"
        Write-Host "‚úÖ Web project: $env:WEBPROJ_PATH"

    # 4Ô∏è‚É£ Restaurar dependencias
    - name: Restore NuGet packages
      run: nuget restore "$env:SOLUTION_PATH"

    # 5Ô∏è‚É£ Construir y empaquetar para publicaci√≥n
    - name: Build and package web app (Release)
      run: |
        msbuild "$env:WEBPROJ_PATH" /p:Configuration=Release /p:DeployOnBuild=true `
          /p:WebPublishMethod=Package /p:PackageAsSingleFile=false `
          /p:SkipInvalidConfigurations=true `
          /p:PackageLocation=".\obj\Release\Package"

    # 6Ô∏è‚É£ Detectar carpeta de publicaci√≥n
    - name: Locate publish output
      shell: pwsh
      run: |
        $pkg = Get-ChildItem -Recurse -Directory -Filter PackageTmp | Select-Object -First 1
        if (-not $pkg) {
          $pkg = Get-ChildItem -Recurse -Directory -Filter Package | Select-Object -First 1
        }
        if (-not $pkg) { throw "‚ùå No se encontr√≥ carpeta Package o PackageTmp (sitio publicado)." }

        "PKG_PATH=$($pkg.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
        Write-Host "üì¶ Carpeta de publicaci√≥n encontrada: $($pkg.FullName)"

    # 7Ô∏è‚É£ Crear ZIP
    - name: Create deployable ZIP
      shell: pwsh
      run: |
        $zipPath = Join-Path $env:GITHUB_WORKSPACE "site.zip"
        if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
        Compress-Archive -Path (Join-Path $env:PKG_PATH '*') -DestinationPath $zipPath -Force
        "PACKAGE_PATH=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Append
        Write-Host "‚úÖ ZIP creado en: $zipPath"

    # 8Ô∏è‚É£ Desplegar en Azure
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: Emplaniapp
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}
        package: ${{ env.PACKAGE_PATH }}
