@model Emplaniapp.Abstracciones.ModelosParaUI.EmpleadoDto
@using Microsoft.AspNet.Identity
@using System.Security.Claims

@{
    ViewBag.Title = $"{Model.nombre} {Model.primerApellido} {Model.segundoApellido}";
    var seccionActiva = ViewBag.Seccion ?? "Datos personales";
   

    // Definir funciones de rol activo localmente (compatibles con C#5)
    var claimsIdentity = User != null ? User.Identity as ClaimsIdentity : null;
    Claim roleClaim = null;
    if (claimsIdentity != null)
    {
        roleClaim = claimsIdentity.FindFirst(ClaimTypes.Role);
    }
    string userRole = "Usuario";
    if (roleClaim != null)
    {
        userRole = roleClaim.Value;
    }

    Func<string> getActiveRole = () =>
    {
        var activeRole = Session != null ? Session["ActiveRole"] as string : null;
        if (!string.IsNullOrEmpty(activeRole))
        {
            return activeRole;
        }
        return userRole;
    };

    Func<string, bool> isInActiveRole = (role) =>
    {
        var activeRole = getActiveRole();
        return activeRole != null && activeRole.Equals(role, StringComparison.OrdinalIgnoreCase);
    };

    Func<string[], bool> isInAnyActiveRole = (roles) =>
    {
        var activeRole = getActiveRole();
        if (activeRole == null || roles == null) return false;
        return roles.Any(role => activeRole.Equals(role, StringComparison.OrdinalIgnoreCase));
    };

    Func<string, bool> isNotInActiveRole = (role) =>
    {
        return !isInActiveRole(role);
    };


    var boleano = !(Model.IdNetUser).Equals(User.Identity.GetUserId());
    ViewBag.UserBoolean = boleano;
}

<!-- Estilos -->
@*<link type="text/css" href="@Href("~/Content/CSS/estilosDatos.css")" rel="Stylesheet" />*@
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>



<!-- T√≠tulo del empleado -->
<div class="row">
    <div class="col-md-12">
        @if (boleano){

            <a class="btn btn-light text-primary mb-2" href="@Url.Action("listarEmpleados","Empleado")">
                <i class="bi bi-arrow-left-short"></i>
                Volver
            </a>
            <br />
        }
        <h2 class="title">@Model.nombre @Model.primerApellido @Model.segundoApellido</h2>
        <br />
        
    </div>
</div>

<!-- Mensaje de √©xito -->
@*@if (TempData["Mensaje"] != null)
{
    <br />
    <div class="alert alert-success">
        @TempData["Mensaje"]
    </div>
}
<br />*@


<!-- Enlaces de navegaci√≥n -->
<div class="row">
    <div class="col-md-12">
        <div class="nav nav-tabs" role="tablist">         

            <a href="@Url.Action("Detalles", "DatosPersonales", new { id = Model.idEmpleado, seccion = "Datos personales" })" class="@(seccionActiva == "Datos personales" ? "active" : "") nav-item nav-link">Datos personales</a>
            <a href="@Url.Action("Detalles", "DatosPersonales", new { id = Model.idEmpleado, seccion = "Historial" })" class="@(seccionActiva == "Historial" ? "active" : "") nav-item nav-link">Historial</a>
            @if (isInActiveRole("Administrador") && boleano)
            {
                <a href="@Url.Action("Detalles", "DatosPersonales", new { id = Model.idEmpleado, seccion = "Roles y Permisos" })" class="@(seccionActiva == "Roles y Permisos" ? "active" : "") nav-item nav-link">Roles y Permisos</a>
            }
            @if (isInActiveRole("Contador"))
            {
                <a href="@Url.Action("DetallesRemu", "Remuneraciones", new { id = Model.idEmpleado })" class="@(seccionActiva == "Remuneraciones" ? "active" : "")  nav-item nav-link">Remuneraciones</a>
                <a href="@Url.Action("Detalles", "Retenciones", new { id = Model.idEmpleado })" class="@(seccionActiva == "Retenciones" ? "active" : "")  nav-item nav-link">Retenciones</a>
                <a href="@Url.Action("Detalles", "Liquidaciones", new { id = Model.idEmpleado })" class="@(seccionActiva == "Liquidacion" ? "active" : "")  nav-item nav-link">Liquidaci&oacute;n</a>
            }
            <a href="@Url.Action("Detalles", "DatosPersonales", new { id = Model.idEmpleado, seccion = "Observaciones" })" class="@(seccionActiva == "Observaciones" ? "active" : "")  nav-item nav-link">Observaciones</a>
        </div>
        <br />
    </div>
</div>


<!-- Contenido -->
    <div class="row">
        <div class="col-md-12">
            @if (seccionActiva == "Datos personales")
            {
                <div id="contenido-datos-personales">

                    <div class="text-center mb-2">
                        <h2><strong>Datos Personales</strong></h2>
                        <br />
                    </div>
                    <div class="row">
                        <div class="col-md-6">

                            <!-- Informaci√≥n personal -->
                            <div class="card card-block card-stretch">
                                <div class="card-header row justify-content-between m-0">
                                    <h3><i class="bi bi-person-fill"></i> Informaci&oacute;n personal</h3>

                                    @if (isInAnyActiveRole(new[] { "Administrador", "Empleado" }))
                                    {
                                        <a href="@Url.Action("EditarDatosPersonales", "DatosPersonales", new { id = Model.idEmpleado })"
                                           class="btn btn-light text-primary">
                                            <i class="bi bi-pencil-fill"></i>
                                        </a>
                                    }
                                </div>
                                <div class="card-body">
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.nombre)</div>
                                        <div class="datos-value">@Model.nombre</div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(Model.segundoNombre))
                                    {
                                        <div class="datos-row">
                                            <div class="datos-label">@Html.DisplayNameFor(m => @Model.segundoNombre)</div>
                                            <div class="datos-value">@Model.segundoNombre</div>
                                        </div>
                                    }
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.primerApellido)</div>
                                        <div class="datos-value">@Model.primerApellido</div>
                                    </div>
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.segundoApellido)</div>
                                        <div class="datos-value">@Model.segundoApellido</div>
                                    </div>
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.fechaNacimiento)</div>
                                        <div class="datos-value">@Model.fechaNacimiento.ToString("dd/MM/yyyy")</div>
                                    </div>
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.cedula)</div>
                                        <div class="datos-value">@Model.cedula</div>
                                    </div>
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.direccionCompleta)</div>
                                        <div class="datos-value">@Model.direccionCompleta</div>
                                    </div>
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.correoInstitucional)</div>
                                        <div class="datos-value">@Model.correoInstitucional</div>
                                    </div>
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.numeroTelefonico)</div>
                                        <div class="datos-value">@Model.numeroTelefonico</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Contacto de emergencia -->
                            @*<div class="card card-block card-stretch">
                    <div class="card-header row justify-content-between m-0">
                        <h3><i class="bi bi-person-lines-fill"></i> Contactos de Emergencia</h3>
                        @if (isInAnyActiveRole(new[] { "Administrador", "Empleado" }))
                        {
                            <a href="#"
                               class="btn btn-light text-primary">
                                <i class="bi bi-pencil-fill"></i>
                            </a>
                        }
                    </div>

                    <div class="card-body text-danger">
                        <div class="datos-row">
                            <div class="datos-label">Nombre de contacto</div>
                            <div class="datos-value">@Model.nombre</div>
                        </div>
                        <div class="datos-row">
                            <div class="datos-label">Relacion con empleado</div>
                            <div class="datos-value">Pariente</div>
                        </div>

                        <div class="datos-row">
                            <div class="datos-label">Tel√©fono:</div>
                            <div class="datos-value">@Model.numeroTelefonico</div>
                        </div>
                    </div>
                </div>*@

                        </div>

                        <!-- -------------------------------------------- -->

                        <div class="col-md-6">
                            <!-- Datos Laborales -->
                            <div class="card card-block card-stretch">
                                <div class="card-header row justify-content-between m-0">
                                    <h3><i class="bi bi-briefcase-fill"></i> Datos Laborales</h3>
                                    @if (isInAnyActiveRole(new[] { "Administrador", "Contador" }))
                                    {
                                        <a href="@Url.Action("EditarDatosLaborales", "DatosPersonales", new { id = Model.idEmpleado })"
                                           class="btn btn-light text-primary">
                                            <i class="bi bi-pencil-fill"></i>
                                        </a>
                                    }
                                </div>
                                <div class="card-body">
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.idCargo)</div>
                                        <div class="datos-value">9832</div>
                                    </div>
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.nombreCargo)</div>
                                        <div class="datos-value">@Model.nombreCargo</div>
                                    </div>
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.fechaContratacion)</div>
                                        <div class="datos-value">@Model.fechaContratacion.ToString("dd/MM/yyyy")</div>
                                    </div>
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.fechaSalida)</div>
                                        <div class="datos-value">@(Model.fechaSalida.HasValue ? Model.fechaSalida.Value.ToString("dd/MM/yyyy") : "--/--/----")</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Datos Financieros -->
                            <div class="card card-block card-stretch">
                                <div class="card-header row justify-content-between m-0">
                                    <h3><i class="bi bi-bank2"></i> Datos Financieros</h3>
                                    @if (isInAnyActiveRole(new[] { "Administrador", "Contador" }))
                                    {
                                        <a href="@Url.Action("EditarDatosFinancieros", "DatosPersonales", new { id = Model.idEmpleado })"
                                           class="btn btn-light text-primary">
                                            <i class="bi bi-pencil-fill"></i>
                                        </a>
                                    }
                                </div>
                                <div class="card-body">
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.periocidadPago)</div>
                                        <div class="datos-value">@Model.periocidadPago</div>
                                    </div>
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.salarioAprobado)</div>
                                        <div class="datos-value">@Model.salarioAprobado.ToString("C")</div>
                                    </div>
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.nombreMoneda)</div>
                                        <div class="datos-value">@Model.nombreMoneda</div>
                                    </div>
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.cuentaIBAN)</div>
                                        <div class="datos-value">@Model.cuentaIBAN</div>
                                    </div>
                                    <div class="datos-row">
                                        <div class="datos-label">@Html.DisplayNameFor(m => @Model.nombreBanco)</div>
                                        <div class="datos-value">@Model.nombreBanco</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            else if (seccionActiva == "Historial")
            {
                <div id="contenedor-lista-historial">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando historial...</p>
                    </div>
                </div>
            }

            else if (seccionActiva == "Roles y Permisos")
            {
                if (isInActiveRole("Administrador"))
                {
                    <div id="contenedor-roles-permisos">
                        @Html.Partial("_RolesYPermisos", Model)
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="fa fa-exclamation-triangle"></i>
                        No tienes permisos para acceder a esta secci√≥n.
                    </div>
                }
            }

            else if (seccionActiva == "Observaciones")
            {
                <div id="contenedor-lista-observaciones"> </div>
            }
        </div>
    </div>


@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Html.Partial("_AdminPasswordModal")

    <script>
        $(document).ready(function () {

            // --- INICIO: L√≥gica de carga y filtrado de observaciones ---
            function cargarObservaciones() {
                var empleadoId = @Model.idEmpleado;
                var container = $('#contenedor-lista-observaciones');

                // Leer valores de los filtros
                var ano = container.find('#filtro-ano').val();
                var mes = container.find('#filtro-mes').val();
                var usuarioId = container.find('#filtro-usuario').val();

                var url = '@Url.Action("ObtenerListaObservaciones", "DatosPersonales")' +
                          '?id=' + empleadoId +
                          '&ano=' + (ano || '') +
                          '&mes=' + (mes || '') +
                          '&usuarioId=' + (usuarioId || '');

                container.html("<p>Cargando observaciones...</p>");

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function (response) {
                        if (response.success) {
                            container.html(response.html);
                        } else {
                            container.html("<p class='text-danger'>Hubo un problema al obtener las observaciones.</p>");
                        }
                    },
                    error: function (xhr) {
                        container.html("<p class='text-danger'>Error al cargar las observaciones: " + xhr.status + ' ' + xhr.statusText + "</p>");
                    }
                });
            }

            if ('@seccionActiva' === 'Observaciones') {
                cargarObservaciones();
            }

            // --- INICIO: L√≥gica de carga del historial ---
            function cargarHistorial() {
                var empleadoId = @Model.idEmpleado;
                var container = $('#contenedor-lista-historial');

                console.log('üîç Iniciando carga de historial para empleado:', empleadoId);
                container.html("<div class='loading'><div class='spinner'></div><p>Cargando historial...</p></div>");

                var url = '@Url.Action("Empleado", "Historial")';
                console.log('üåê URL de la petici√≥n:', url);

                $.ajax({
                    url: url,
                    type: 'GET',
                    data: { id: empleadoId },
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    beforeSend: function() {
                        console.log('üì§ Enviando petici√≥n AJAX...');
                    },
                    success: function (response) {
                        console.log('‚úÖ Respuesta recibida:', response);
                        container.html(response);
                    },
                    error: function (xhr, status, error) {
                        console.error('‚ùå Error en la petici√≥n AJAX:', {xhr: xhr, status: status, error: error});
                        container.html("<p class='text-danger'>Error al cargar el historial: " + xhr.status + ' ' + xhr.statusText + "</p>");
                    }
                });
            }

            if ('@seccionActiva' === 'Historial') {
                cargarHistorial();
            }
            // --- FIN: L√≥gica de carga del historial ---

            // Listener para el bot√≥n de aplicar filtros
            $('#contenedor-lista-observaciones').on('click', '#btn-aplicar-filtros', function() {
                cargarObservaciones();
            });

            // Listener para el bot√≥n de quitar filtros
            $('#contenedor-lista-observaciones').on('click', '#btn-quitar-filtros', function() {
                var container = $('#contenedor-lista-observaciones');
                container.find('#filtro-ano').val('');
                container.find('#filtro-mes').val('');
                container.find('#filtro-usuario').val('');
                cargarObservaciones();
            });

            // --- INICIO: L√≥gica del modal para agregar/editar observaciones ---
            var modalContainer = $('#modal-container');
            var modalContent = $('#modal-content-container');

            // Abrir modal (agregar/editar)
            $('#contenedor-lista-observaciones').on('click', '.btn-agregar-observacion, .btn-editar-observacion', function () {
                var url = $(this).data('url');
                modalContent.load(url, function () {
                    modalContainer.modal('show');
                    
                    // ‚ú® CORRECCI√ìN: Verificar que jQuery Unobtrusive est√© disponible
                    if (typeof $.validator !== 'undefined' && typeof $.validator.unobtrusive !== 'undefined') {
                        $.validator.unobtrusive.parse(modalContent.find('form'));
                    } else {
                        console.warn('jQuery Unobtrusive no est√° disponible para validaci√≥n');
                    }
                });
            });

            // Guardar en modal
            modalContainer.on('click', '#btn-guardar-observacion', function () {
                var form = modalContent.find('#observacionForm');
                
                // ‚ú® CORRECCI√ìN: Validaci√≥n manual si jQuery Unobtrusive no est√° disponible
                var isValid = true;
                if (typeof form.valid === 'function') {
                    isValid = form.valid();
                } else {
                    // Validaci√≥n manual b√°sica
                    var titulo = form.find('input[name="Titulo"]').val().trim();
                    var descripcion = form.find('textarea[name="Descripcion"]').val().trim();
                    
                    if (!titulo || !descripcion) {
                        isValid = false;
                        alert('Por favor, complete todos los campos obligatorios.');
                    }
                }
                
                if (!isValid) return;

                // ‚ú® MEJORA: Deshabilitar bot√≥n para evitar doble env√≠o
                var btnGuardar = $(this);
                btnGuardar.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Guardando...');

                $.ajax({
                    url: form.attr('action'),
                    method: 'POST',
                    data: form.serialize(),
                    success: function (response) {
                        // ‚ú® CORRECCI√ìN: Manejar respuesta como texto o JSON
                        var responseData = response;
                        if (typeof response === 'string') {
                            try {
                                responseData = JSON.parse(response);
                            } catch (e) {
                                // Si no es JSON, probablemente es HTML de error
                                modalContent.html(response);
                                if (typeof $.validator !== 'undefined' && typeof $.validator.unobtrusive !== 'undefined') {
                                    $.validator.unobtrusive.parse(modalContent.find('form'));
                                }
                                return;
                            }
                        }
                        
                        if (responseData.success) {
                            modalContainer.modal('hide');
                            
                            // ‚ú® MEJORA: Mostrar mensaje de √©xito elegante
                            if (typeof window.showSuccessModal === 'function') {
                                var mensaje = form.find('input[name="IdObservacion"]').val() > 0 
                                    ? 'La observaci√≥n ha sido actualizada exitosamente' 
                                    : 'La observaci√≥n ha sido creada exitosamente';
                                window.showSuccessModal(mensaje);
                            }
                            
                            cargarObservaciones();
                        } else {
                            modalContent.html(responseData);
                            if (typeof $.validator !== 'undefined' && typeof $.validator.unobtrusive !== 'undefined') {
                                $.validator.unobtrusive.parse(modalContent.find('form'));
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error al guardar observaci√≥n:', error);
                        console.error('Respuesta del servidor:', xhr.responseText);
                        
                        // ‚ú® MEJORA: Mostrar mensaje de error elegante
                        if (typeof window.showErrorModal === 'function') {
                            window.showErrorModal('Ocurri√≥ un error al guardar la observaci√≥n. Por favor, intente nuevamente.');
                        } else {
                            alert('Ocurri√≥ un error de comunicaci√≥n con el servidor.');
                        }
                    },
                    complete: function () {
                        // ‚ú® MEJORA: Rehabilitar bot√≥n
                        btnGuardar.prop('disabled', false).html('Guardar');
                    }
                });
            });


            modalContainer.on('click', '#btn-cancelar-observacion', function () {
                $('#modal-container').modal('hide');
            });

            // ‚ú® NUEVO: Eliminar observaci√≥n
            $('#contenedor-lista-observaciones').on('click', '.btn-eliminar-observacion', function () {
                var observacionId = $(this).data('id');
                var observacionTitulo = $(this).data('titulo');
                
                if (confirm('¬øEst√° seguro de que desea eliminar la observaci√≥n "' + observacionTitulo + '"? Esta acci√≥n no se puede deshacer.')) {
                    $.ajax({
                        url: '@Url.Action("EliminarObservacion", "DatosPersonales")',
                        method: 'POST',
                        data: { 
                            id: observacionId,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (response) {
                            if (response.success) {
                                // ‚ú® MEJORA: Mostrar mensaje de √©xito elegante
                                if (typeof window.showSuccessModal === 'function') {
                                    window.showSuccessModal('La observaci√≥n ha sido eliminada exitosamente');
                                }
                                cargarObservaciones();
                            } else {
                                // ‚ú® MEJORA: Mostrar mensaje de error elegante
                                if (typeof window.showErrorModal === 'function') {
                                    window.showErrorModal(response.message || 'Ocurri√≥ un error al eliminar la observaci√≥n');
                                } else {
                                    alert(response.message || 'Ocurri√≥ un error al eliminar la observaci√≥n');
                                }
                            }
                        },
                        error: function () {
                            // ‚ú® MEJORA: Mostrar mensaje de error elegante
                            if (typeof window.showErrorModal === 'function') {
                                window.showErrorModal('Ocurri√≥ un error de comunicaci√≥n con el servidor');
                            } else {
                                alert('Ocurri√≥ un error de comunicaci√≥n con el servidor');
                            }
                        }
                    });
                }
            });

            // --- FIN: L√≥gica del modal ---
        });
    </script>
}

<!-- Modal Gen√©rico (Solo el contenedor) -->
<div class="modal fade" id="modal-container"  tabindex="-1" role="dialog" aria-labelledby="modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" id="modal-content-container">
            <!-- El contenido completo del modal (header, body, footer) se cargar√° aqu√≠ -->
        </div>
    </div>
</div>



