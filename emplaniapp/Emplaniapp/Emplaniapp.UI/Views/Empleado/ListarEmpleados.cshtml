@model IEnumerable<Emplaniapp.Abstracciones.ModelosParaUI.EmpleadoDto>

@{
    ViewBag.Title = "Empleados";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>



<div class="row">
    <div class="col-md-9 mb-2">
        <!--Título y subtítulo-->
        <h1 class="mb-2">Empleados</h1>
        <span class="text-secondary">Total de empleados: @ViewBag.TotalEmpleados</span>
    </div>
    <div class="col-md-3 align-items-center justify-content-end display-block">
        <!-- Agregar Empleados -->
        <h1 class="mb-2"> </h1>
        <a href="@Url.Action("CrearEmpleado", "Empleado")" class="btn btn-primary" style=" width:100%; float:right;">
            <i class="bi bi-person-add"></i>
            Agregar Empleado
        </a>
    </div>
</div>



@if (TempData["Mensaje"] != null)
{
    <br />
    <div class="alert alert-primary">
        @TempData["Mensaje"]
    </div>
}

<div class="modal fade" id="modalCambiarEstado" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Aquí se cargará la vista parcial -->
        </div>
    </div>
</div>

<br />

<!-- Filtros -->
<div>
    @using (Html.BeginForm("Filtrar", "Empleado", FormMethod.Post, new { id = "formFiltrarEmpleado" }))
    {
        <div class="d-flex justify-content-center align-items-center mb-4 p-2 bg-white" style="border-radius:10px;">
            <div class="d-flex align-items-center">
                <div class="m-2">
                    <input type="text" name="filtro" value="@ViewBag.Filtro" class="form-control" placeholder="Nombre o cédula" />
                </div>
                <div class="m-2">
                    @Html.DropDownList("idCargo", new SelectList(ViewBag.Cargos, "Value", "Text", ViewBag.idCargo), "Todos los cargos", new { @class = "form-control" })
                </div>
                <div class="m-2">
                    @Html.DropDownList("idEstado", new SelectList(ViewBag.Estados, "Value", "Text", ViewBag.idEstado), "Todos los estados", new { @class = "form-control" })
                </div>
                <div class="m-2">
                    <button type="submit" class="btn btn-outline-primary" id="btnFiltrar">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                </div>
                @if (!string.IsNullOrEmpty(ViewBag.Filtro as string) || (ViewBag.idCargo != null && ViewBag.idCargo != 0) || (ViewBag.idEstado != null && ViewBag.idEstado != 0))
                {
                    <div class="m-2">
                        <a href="@Url.Action("ListarEmpleados", "Empleado")" class="btn btn-outline-secondary">
                            <i class="bi bi-x"></i>Quitar
                        </a>
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- Tabla de Empleados -->
<div class="card card-block card-stretch card-height">
    <div class="card-body">

        
        <div class="table-responsive">
            <table class="table table-hover mb-0 rounded-4" id="TablaEmpleado">
                <thead>
                    <tr>
                        <th scope="col">@Html.DisplayNameFor(model => model.FirstOrDefault().cedula)</th>
                        <th scope="col">@Html.DisplayNameFor(model => model.FirstOrDefault().nombreCompleto)</th>
                        <th scope="col">@Html.DisplayNameFor(model => model.FirstOrDefault().nombreCargo)</th>
                        <th scope="col">@Html.DisplayNameFor(model => model.FirstOrDefault().RolesUsuario)</th>
                        <th scope="col">@Html.DisplayNameFor(model => model.FirstOrDefault().nombreEstado)</th>
                        <th scope="col">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                        <tr>
                            <td>@Html.DisplayFor(modelItem => item.cedula)</td>
                            <td>@($"{item.nombre} {item.segundoNombre} {item.primerApellido} {item.segundoApellido}")</td>
                            <td>@Html.DisplayFor(modelItem => item.nombreCargo)</td>
                            <td>
                                <span class="badge bg-light">
                                    @Html.DisplayFor(modelItem => item.RolesUsuario)
                                </span>
                            </td>
                            <td>
                                @{
                                    var estado = Html.DisplayFor(modelItem => item.nombreEstado).ToString();
                                }

                                @if (estado == "Activo")
                                {
                                    <span class="badge bg-success-light">
                                        @Html.DisplayFor(modelItem => item.nombreEstado)
                                    </span>
                                }
                                else if (estado == "Inactivo")
                                {
                                    <span class="badge bg-danger-light">
                                        @Html.DisplayFor(modelItem => item.nombreEstado)
                                    </span>
                                }
                                else if (estado == "En Licencia")
                                {
                                    <span class="badge bg-warning-light">
                                        @Html.DisplayFor(modelItem => item.nombreEstado)
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-light">
                                        @Html.DisplayFor(modelItem => item.nombreEstado)
                                    </span>
                                }



                            </td>
                            <td>
                                @* Ver perfil/detalles del empleado seleccionado *@
                                <a href="@Url.Action("Detalles", "DatosPersonales", new { id = item.idEmpleado})" class="btn btn-outline-primary mb-1" style="min-width:116px;">
                                    <i class="bi bi-eye"></i>
                                    Detalles
                                </a>
                                
                                @* Enlaces de edición DIRECTA, siempre enviando id = item.idEmpleado *@
                                <!--<a href="@Url.Action("EditarDatosPersonales",  "DatosPersonales", new { id = item.idEmpleado })"
                                   class="btn-celeste-claro">Editar personales</a>
                                <a href="@Url.Action("EditarDatosLaborales",   "DatosPersonales", new { id = item.idEmpleado })"
                                   class="btn-celeste-claro">Editar laborales</a>
                                <a href="@Url.Action("EditarDatosFinancieros", "DatosPersonales", new { id = item.idEmpleado })"
                                   class="btn-celeste-claro">Editar financieros</a>-->

                                @* Cambiar estado (modal) *@
                                <a href="@Url.Action("_CambiarEstado", "Empleado", new { id = item.idEmpleado })"
                                   class="btn btn-outline-warning"
                                   style="min-width:116px;"
                                   data-toggle="modal"
                                   data-target="#modalCambiarEstado"
                                   data-url="@Url.Action("_CambiarEstado", "Empleado", new { id = item.idEmpleado })">
                                    <i class="bi bi-arrow-repeat"></i>
                                    Estado
                                </a>
                            </td>
                        </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="alert alert-info d-inline-block">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>No se encontraron empleados</strong>
                                    @if (!string.IsNullOrEmpty(ViewBag.Filtro as string) || (ViewBag.idCargo != null && ViewBag.idCargo != 0) || (ViewBag.idEstado != null && ViewBag.idEstado != 0))
                                    {
                                        <br />
                                        <small>con los filtros aplicados. Intenta ajustar los criterios de búsqueda.</small>
                                        <br />
                                        <a href="@Url.Action("ListarEmpleados", "Empleado")" class="btn btn-sm btn-outline-primary mt-2">
                                            <i class="bi bi-arrow-clockwise"></i> Ver todos los empleados
                                        </a>
                                    }
                                    else
                                    {
                                        <br />
                                        <small>No hay empleados registrados en el sistema.</small>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

        </div>
    </div>
</div>



@section Scripts {
    <script>
        // Cargar parcial en modal "Cambiar Estado"
        $(document).on('click', 'a[data-toggle="modal"]', function (e) {
            e.preventDefault();
            var url = $(this).data("url");
            var modal = $($(this).data("target"));

            $.get(url, function (data) {
                modal.find(".modal-content").html(data);
                modal.modal("show");
            });
        });

        // ✨ NUEVO: Validación del formulario de filtro
        $('#formFiltrarEmpleado').on('submit', function (e) {
            var filtro = $(this).find('input[name="filtro"]').val();
            // usar name->id: los DropDowns generan id igual al name por defecto
            var idCargo = $(this).find('select[name="idCargo"]').val();
            var idEstado = $(this).find('select[name="idEstado"]').val();

                console.log('🔍 DIAGNÓSTICO: Filtro - Texto:', filtro, 'Cargo:', idCargo, 'Estado:', idEstado);
                
                // Si todos los filtros están vacíos, redirigir a la lista completa
                if ((!filtro || filtro.trim() === '') && 
                    (!idCargo || idCargo === '' || idCargo === '0') && 
                    (!idEstado || idEstado === '' || idEstado === '0')) {
                    
                    console.log('🔍 DIAGNÓSTICO: Todos los filtros están vacíos, redirigiendo a lista completa');
                    e.preventDefault();
                    window.location.href = '@Url.Action("ListarEmpleados", "Empleado")';
                    return false;
                }
                
                console.log('🔍 DIAGNÓSTICO: Filtros válidos, enviando formulario');
                return true;
            });
        });

        // Filtro en vivo (solo si existe el input de filtro)
        $(function () {
            var $search = $("input[name='filtro']");
            if ($search.length) {
                $search.on("keyup", function () {
                    var value = $(this).val().toLowerCase();
                    $("#TablaEmpleado tbody tr").each(function () {
                        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                    });
                });
            }

            var $clear = $("#limpiarFiltro");
            if ($clear.length) {
                $clear.on("click", function () {
                    $search.val('');
                    $search.trigger("keyup");
                });
            }
        });
    </script>
}
